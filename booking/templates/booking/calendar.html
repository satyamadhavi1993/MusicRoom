{% extends 'base/layout.html' %}
{% block content %}
{% if user.is_authenticated %}
<h3>Welcome, {{ user.username }}!</h3>
{% endif %}
<h4>Calendar for {{ current_day }}, {{ current_date }}</h4>
<div class="btn-group">
    <a class="btn btn-mini" href="?date={{ previous_date|date:'Y-m-d' }}"><i
            class="fa-sharp fa-solid fa-chevron-left"></i></a>
    <a class="btn btn-mini disabled">{{ current_date|date:"m/d" }}</a>
    <a class="btn btn-mini" href="?date={{ next_date|date:'Y-m-d' }}"><i
            class="fa-sharp fa-solid fa-chevron-right"></i></a>
</div>

<form method="post" id="reserveForm" action="{% url 'booking:calendar' %}">
    {% csrf_token %}
    <input type="hidden" name="date" id="reserveDate">
    <input type="hidden" name="time" id="reserveTime">
    <input type="hidden" name="time_slot" id="reserveTimeSlot">
    <input type="hidden" name="room_type" id="reserveRoomType">
    <br><br>
    <table class="list calendar" cellpadding="0" cellspacing="0">
        <tr>
            <th rowspan="2">Time</th>
            <th colspan="3">Available Studios</th>
        </tr>
        <tr>
            <th>Solo</th>
            <th>Duet</th>
            <th>Band</th>
        </tr>
        {% for time_slot in time_slot_data.values %}
        <tr>
            <td class="time-slot">{{ time_slot.start_time }} - {{ time_slot.end_time }}</td>
            <td class="room-type" data-time="{{ time_slot.start_time }}"
                data-time-slot="{{ time_slot.start_time }} - {{ time_slot.end_time }}" data-room-type="Solo"
                onclick="submitReserveForm('{{ current_date }}', '{{ time_slot.start_time }}', this)">
                {{ time_slot.available_solo_rooms }}</td>
            <td class="room-type" data-time="{{ time_slot.start_time }}"
                data-time-slot="{{ time_slot.start_time }} - {{ time_slot.end_time }}" data-room-type="Duet"
                onclick="submitReserveForm('{{ current_date }}', '{{ time_slot.start_time }}', this)">
                {{ time_slot.available_duet_rooms }}</td>
            <td class="room-type" data-time="{{ time_slot.start_time }}"
                data-time-slot="{{ time_slot.start_time }} - {{ time_slot.end_time }}" data-room-type="Band"
                onclick="submitReserveForm('{{ current_date }}', '{{ time_slot.start_time }}', this)">
                {{ time_slot.available_band_rooms }}</td>
        </tr>
        {% endfor %}
    </table>
</form>
<script type="text/javascript">
    
    function submitReserveForm(date, time, element) {
        document.getElementById('reserveDate').value = date;
        document.getElementById('reserveTime').value = time;
        document.getElementById('reserveTimeSlot').value = element.getAttribute('data-time-slot');
        document.getElementById('reserveRoomType').value = element.getAttribute('data-room-type');;
        document.getElementById('reserveForm').submit();
    }

    function markReserved(element) {
        element.style.backgroundColor = 'green';
        element.style.fontWeight = 'bold';
    }

    document.addEventListener('DOMContentLoaded', (event) => {
        const reservationsJson = JSON.parse('{{ reservations|escapejs }}');
        for (const reservation of reservationsJson) {
            var reservationTime = reservation.time;
            var reservationRoomType = reservation.room_type;
            var selector = `[data-time="${reservationTime}"][data-room-type="${reservationRoomType}"]`;
            var element = document.querySelector(selector);
            markReserved(element);
        }
    });
</script>
{% endblock %}